# Choral Explanations


## Development Setup

If you're setting up your computer for the first time, this tutorial may be helpful: http://railsapps.github.io/installrubyonrails-mac.html

Clone the repo:
```
git clone https://github.com/lumenlearning/choral_explanations.git
cd choral_explanations
```

## System Dependencies

### Mac OS X

For OS X, you'll need to install the [Command Line Tools for Xcode](http://developer.apple.com/downloads),

Make ruby 2.2.latest system default ([rbenv](https://github.com/rbenv/rbenv) works well for this)

You also need Postgres and the [xmlsec library](http://www.aleksey.com/xmlsec/) installed.
The easiest way to get these is via [homebrew](http://brew.sh/).
Once you have homebrew installed, just run:

```
brew install postgresql nodejs xmlsec1
```

Set default node to appropriate version -currently v6.9.1 ([nvm](https://github.com/creationix/nvm) does this)

### Debian/Ubuntu

```
sudo apt-get install libxml2-dev postgresql libpq-dev libxmlsec1-dev curl make g++ build-essential libssl-dev
```

## Installing Gems to a user folder
------

If you want Ruby Gems to install to the user directory (recommended) instead of system-level you can by
setting the *GEM_HOME* environment variable prior to running either Ruby Gems or Bundler (described below).

```
mkdir ~/.gems
export GEM_HOME=~/.gems

#linux
echo "export GEM_HOME=~/.gems" >> ~/.bashrc
echo "export PATH=$PATH:~/.gems/bin" >> ~/.bashrc

#osx
echo "export GEM_HOME=~/.gems" >> ~/.bash_profile
echo "export PATH=$PATH:~/.gems/bin" >> ~/.bash_profile
```

## Bundler

```
gem install bundler
```

Now in your choral_explanations folder install all the gem dependencies like this:
```
~/choral_explanations$ bundle install
```

## Client Javascript App

The entire frontend is in the `/client` folder. You have to set it up as well.
You should use Node 5.x+

```
~/choral_explanations$ cd client
~/choral_explanations$ npm install
```


## Data setup

### Default configuration

Before we set up all the tables in your database, our Rails code depends on a
small few configuration files, you can pull in the default configuration values like so:

```
~/choral_explanations$ for config in secrets database; do cp -v config/$config.yml.example config/$config.yml; done
```

Now edit the `config/secrets.yml` file and replace the pieces specified with values generated by:
```
bundle exec rake secret
```

### Database configuration
Now we need to set up your database configuration.

#### OSX

```
~/choral_explanations$ createdb choral_explanations_development
~/choral_explanations$ createdb choral_explanations_test
```

#### Ubuntu
You may have to create the tables and a user for them the hard way:

```
sudo su - postgres
psql
alter user choral_explanations password 'choral_explanations';
create user choral_explanations with password 'choral_explanations';
create database choral_explanations_development owner choral_explanations;
create database choral_explanations_test owner choral_explanations;
```

Then add that user to the default section in `config/database.yml`


#### Migrate the DB

Migrate your development and test databases:

```
~/choral_explanations$ bundle exec rake db:setup
~/choral_explanations$ RAILS_ENV=test bundle exec rake db:reset
```

## Running Tests

You should now be able to run the tests:
```
~/choral_explanations$ bundle exec rake
```

## Running the server and assets compilation
You need to compile the client app in order for the UI to work:
```
~/choral_explanations$ bundle exec rake assets:webpack
```

Or, if you're going to be making changes to the client and you want the changes
to reload as you work, you can:
```
~/choral_explanations$ bundle exec rake assets:webpack:watch
```

Then, in a new shell, run the rails server and the app should be running at http://localhost:3000/dev:
```
~/choral_explanations$ bundle exec rails server
```
